name: Build, Push and Run EasyTier

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: aoxijy/easytier-mange

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  run-easytier:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup TUN device (with error handling)
      run: |
        # 创建 TUN 设备目录
        sudo mkdir -p /dev/net
        
        # 检查 TUN 设备是否已存在，如果不存在则创建
        if [ ! -c /dev/net/tun ]; then
          echo "创建 TUN 设备..."
          sudo mknod /dev/net/tun c 10 200
          sudo chmod 0666 /dev/net/tun
          echo "TUN设备创建完成"
        else
          echo "TUN设备已存在，跳过创建"
          # 确保权限正确
          sudo chmod 0666 /dev/net/tun
        fi
        
        # 验证 TUN 设备
        echo "验证 TUN 设备:"
        ls -la /dev/net/tun

    - name: Download and prepare EasyTier binary
      run: |
        # 这里根据您的实际情况调整
        # 如果二进制文件在仓库中
        if [ -f "./easytier" ]; then
          chmod +x easytier
          echo "找到 easytier 二进制文件，已设置执行权限"
        else
          echo "未找到 easytier 二进制文件，请确保文件存在"
          # 如果需要下载，在这里添加下载命令
          # wget -O easytier https://example.com/easytier
          # chmod +x easytier
        fi

    - name: Create configuration file
      run: |
        cat > config.toml << 'EOF'
        [core]
        ctrl_listen = "0.0.0.0:15888"

        [network_protocol_stack]
        listeners = [
            "tcp://0.0.0.0:19001",
            "wss://0.0.0.0:19002/",
        ]
        rpc_portal = "0.0.0.0:15889"
        tcp_whitelist = []
        udp_whitelist = []

        [network_identity]
        network_name = "default"
        network_secret = ""

        [[peer]]
        uri = "tcp://gd.et.tianpao.top:11010"

        [[peer]]
        uri = "tcp://gz.server.piedaochuan.top:11010"

        [flags]
        EOF
        
        echo "配置文件创建完成"

    - name: Run EasyTier core service
      run: |
        # 检查二进制文件是否存在
        if [ ! -f "./easytier" ]; then
          echo "错误: 未找到 easytier 二进制文件"
          exit 1
        fi
        
        echo "启动 EasyTier 核心服务..."
        # 使用 sudo 运行 easytier 核心服务
        sudo ./easytier -c config.toml &
        EASYTIER_PID=$!
        echo "EasyTier 进程ID: $EASYTIER_PID"
        
        # 等待服务启动
        sleep 10
        
        # 检查进程是否还在运行
        if ps -p $EASYTIER_PID > /dev/null; then
          echo "✅ EasyTier 核心服务启动成功"
          # 检查端口监听
          echo "检查端口监听状态:"
          sudo netstat -tlnp | grep -E '(15888|19001|19002)' || echo "端口可能还未完全启动"
        else
          echo "❌ EasyTier 核心服务启动失败"
          echo "检查错误日志:"
          journalctl -u easytier --no-pager -n 20 || echo "无法访问系统日志"
          exit 1
        fi

    - name: Run EasyTier Web Embed (if available)
      run: |
        # 检查 web embed 二进制文件是否存在
        if [ -f "./easytier-web-embed" ]; then
          chmod +x ./easytier-web-embed
          echo "启动 EasyTier Web 界面..."
          ./easytier-web-embed --web-server-port 11211 --api-host "https://zw.gqru.com" &
          WEB_PID=$!
          echo "Web 界面进程ID: $WEB_PID"
          sleep 5
          
          # 检查 Web 服务是否启动
          if ps -p $WEB_PID > /dev/null; then
            echo "✅ EasyTier Web 界面启动成功"
          else
            echo "❌ EasyTier Web 界面启动失败"
          fi
        else
          echo "ℹ️ 未找到 easytier-web-embed 二进制文件，跳过 Web 界面启动"
        fi

    - name: Verify services are running
      run: |
        echo "=== 服务运行状态检查 ==="
        echo "1. 检查进程:"
        ps aux | grep -E '(easytier|easytier-web)' | grep -v grep || echo "未找到相关进程"
        
        echo ""
        echo "2. 检查网络端口:"
        sudo netstat -tlnp | grep -E '(15888|19001|19002|11211)' || echo "未找到相关端口监听"
        
        echo ""
        echo "3. 检查系统日志:"
        dmesg | tail -20 | grep -i tun || echo "无相关的 TUN 设备日志"
        
        echo "=== 检查完成 ==="

    - name: Keep services running for testing
      run: |
        echo "服务将持续运行 3 分钟进行测试..."
        # 保持服务运行一段时间以便测试
        for i in {1..18}; do
          echo "运行中... $(date)"
          sleep 10
        done
        echo "测试运行完成"
