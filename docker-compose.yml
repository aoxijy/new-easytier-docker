version: '3.8'

services:
  easytier:
    build:
      context: .
      args:
        - EASYTIER_VERSION=2.4.5
    container_name: easytier
    restart: unless-stopped
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    ports:
      - "${TCP_PORT}:19001/tcp"
      - "${TCP_PORT}:19001/udp"
      - "${WSS_PORT}:19002/tcp"
      - "${WEB_PORT}:11211/tcp"
      - "15889:15889/tcp"
    environment:
      - INSTANCE_NAME=${INSTANCE_NAME}
      - MACHINE_ID=${MACHINE_ID}
      - IPV4=${IPV4}
      - DHCP=${DHCP}
      - HOSTNAME=${HOSTNAME}
      - NETWORK_NAME=${NETWORK_NAME}
      # 敏感信息通过环境文件或运行时传入
      - NETWORK_SECRET=${NETWORK_SECRET}
      - RPC_PORTAL=${RPC_PORTAL}
      - WEB_PORT=${WEB_PORT}
      - API_HOST=${API_HOST}
      - TCP_PORT=${TCP_PORT}
      - WSS_PORT=${WSS_PORT}
      - CONFIG_SERVER=${CONFIG_SERVER}
      - DEFAULT_PROTOCOL=${DEFAULT_PROTOCOL}
      - MTU=${MTU}
      - ENABLE_EXIT_NODE=${ENABLE_EXIT_NODE}
      - DISABLE_P2P=${DISABLE_P2P}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./peers.toml:/app/peers.toml:ro
    healthcheck:
      test: ["CMD", "pidof", "easytier-core"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      easytier-net:
        ipv4_address: ${IPV4}

networks:
  easytier-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.28.0/24
